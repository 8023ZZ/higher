# 概述
### 网络的网络
网络把主机连接起来，而互联网是把网络连接起来
***

### 物理层
***

### 链路层
#### 封装成帧
将网络层传输下来的分组添加首部和尾部，用于标记帧的开始和结束
#### 信道分类
1. 广播信道
2. 点对点信道
   
#### 信道复用技术
1. 频分复用
   频分复用的所有主机在相同的时间占用不同的频率带宽资源。
2. 时分复用
   时分复用的所有主机在不同的时间占用相同的频率带宽资源。
3. 统计时分复用
4. 波分复用
5. 码分复用
   
#### MAC地址
MAC地址是链路层地址，长度为6字节（48位），用于唯一标识网络配置器（网卡）
一台主机有多少网卡就有多少MAC地址

***
### 网络层
#### IP数据包格式
![avatar](/static/IPHeader.png)
***
### 传输层
#### TCP三次握手
![avatar](/static/TCP三次握手.png)
1. Server端处于监听状态，等待Client的链接请求
2. Client向Server端发送链接请求，SYN=1，ACK=0，选择初始序号x
3. Server端收到链接请求报文，如果同意建链，则向Client端发送链接确认报文，SYN=1，ACK=1，确认号为x+1，同时选择一个初始序号y
4. Client收到Server端的链接确认报文后，还要向Server端发出确认，确认号为y+1，序号为x+1
5. Server端收到Client端的确认后，链接建立


##### 三次握手的原因
2次握手：客户端向服务器发送SYN希望建立连接，服务器向客户端发送SYN+ACK表示确认应答。的是如果服务器返回的ACK丢失了，那么客户端就会认为连接建立失败，因为他没有收到服务器的确认应答，但是服务器端却认为连接建立了，因为他已经收到客户端的SYN并且返回了一个ACK。这样就会造成双方认知不一致的问题。那么客户端就会重复性一直向服务器发送连接请求，服务器收到建立连接请求时，也会为该连接分配资源，创建数据结构维护。所以一旦出现上面那种情况，服务器会为它认为已经建立好的连接而消耗很多资源，但是这些都属于无效资源，那么可用有效资源就会逐渐变少。

如果三次握手最后一个ACK丢失的话，服务器认为连接没有建立成功，客户端认为连接已经建立，所以它在向服务器发送请求时，服务器会做出相应，告诉客户端这个是无效连接，通过RST标志位希望重新建立连接。对服务器实际上不受影响，并不会为该无效连接消耗资源。

4次握手：如果三次握手已经足够了，也就不需要四次了。如果四次握手的话，最后一个ACK丢失，又会出现2次握手的情况，造成资源的浪费。

#### TCP四次挥手
![avatar](/static/TCP四次挥手.png)
1. Client端发送链接释放报文，FIN=1
2. Server端收到后发出确认，此时TCP处于半关闭状态，Server能向Client发送数据，但是Client不能向Server发送数据
3. 当Server不再需要链接时，发送链接释放报文，FIN=1
4. Client收到后发出确认，进入TIME-WAIT状态，等待2MSL（最大报文存活时间）后释放连接
5. Server端收到Client的确认后释放链接

##### 四次挥手的原因
客户端发送FIN包，服务器收到报文后，就进入CLOSE-WAIT状态，这个状态是为了让服务器发送还未传送完毕的数据，传送完毕后，Server端会发送FIN包释放链接
客户端收到FIN包进入TIME-WAIT状态，是为了确保：1.最后一个ACK报文能送达，如果Server没收到Client的ACK包，则会重传，Client等待一段时间就是为了处理这种情况。2.为了让本链接持续时间内所产生的所有报文都从网络中消失，使得下一个链接不会出现旧的请求报文

#### TCP可靠传输
TCP使用超时重传来保证可靠性：如果一个发送的报文在超时时间内没有收到确认，那么就重传这个报文
***

### 应用层
#### 域名系统
DNS是一个分布式数据库，提供了主机名和IP地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。
域名有层次结构，从上到下依次为：根域名、顶级域名、二级域名
DNS可以使用UDP或TCP进行传输，使用的端口号为53，大部分情况下DNS使用UDP进行传输。

#### 文件传送协议
FTP使用TCP进行传输，它需要两个链接来传输一个文件
1. 控制链接：服务器打开端口21等待客户端链接，客户端主动建链后，使用这个链接将客户端的命令传送给服务端，并传回服务器的应答
2. 数据链接：用来传送一个文件数据

根据数据链接是否是服务器端主动建立，FTP有主动和被动两种模式：
1. 主动模式：服务器端主动建立数据连接，其中服务器端的端口号为20，客户端端口号随机
2. 被动模式：客户端主动建立数据连接，其中客户端端口号由客户端自己指定，服务端端口号随机
   
主动模式要求客户端开放端口号给服务器端，需要去配置客户端的防火墙。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

#### 动态主机配置协议
DHCP（Dynamic Host Configuration Protocol）配置的不仅是IP，还包括子网掩码、网关IP地址
DHCP工作过程如下：
1. 客户端发送 Discover 报文，该报文的目的地址为255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和DHCP服务器不在同一个子网，就使用中继代理
2. DHCP 服务器收到 Discover 报文后，发送 Offer 报文给客户端，该报文包含客户需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
3. 如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
4. DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。
![avatar](../static/DHCP.jpg)

#### Web网页请求过程
##### 1.DHCP配置主机信息
* 假设主机最开始没有IP地址及其他信息，那么就要先使用DHCP来获取
* 主机生成一个DHCP请求报文，并将这个报文放入具有目的端口67和源端口68的UDP报文中
* 该报文被放入在一个具有广播IP目的地址（255.255.255.255）和源地址（0.0.0.0）的IP数据包中
* 该数据报被放在MAC帧中，该帧具有目的地址 FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF，将广播到与交换机连接的所有设备。
* 连接在交换机的 DHCP 服务器收到广播帧之后，不断地向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文，该报文包含以下信息：IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段有被放入 IP 数据报中，最后放入 MAC 帧中。
* 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。
* 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器的 IP 地址，并在其 IP 转发表中安装默认网关。
##### 2.ARP解析MAC地址
* 主机通过浏览器生成一个 TCP 套接字，套接字向 HTTP 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。
* 主机生成一个 DNS 查询报文，该报文具有 53 号端口，因为 DNS 服务器的端口号是 53。
* 该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。
* 该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。
* DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。
* 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址（FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:<zero-width space>FF:FF）的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器
* 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。
##### 3.DNS解析域名
* 知道网关路由器的 MAC 地址之后，就可以继续DNS的解析过程了
* 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出IP数据报，并根据转发表决定该 IP 数据报应该转发的路由器
* 因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。
* 到达 DNS 服务器后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名
* 找到 DNS 记录后，发送 DNS 回传报文，将回传报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。
##### 4.HTTP请求页面
* 有了 HTTP 服务器的 IP 地址后，主机就能生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文
* 在生成 TCP 套接字之前，必须先与 HTTP 服务器进行三次握手来建立链接，生成一个具有目的端口为80的 TCP SYN 报文段，并向 HTTP 服务器发送该报文段
* HTTP 服务器收到该报文段后，生成 TCP SYN ACK 报文段，然后发回主机
* 建立链接后，浏览器生成 HTTP GET 报文，并交付给 HTTP 服务器
* HTTP 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 WEB 页面内容放入报文主体中，发回主机
* 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。